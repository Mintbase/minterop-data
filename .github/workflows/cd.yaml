name: Sandbox Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-22.04
    name: Diesel and Hasura migrations
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      # Authenticate/setup gcloud
      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"

      - name: Rust setup
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          default: true
          override: true

      - name: Diesel setup
        run: |
          sudo apt-get install libpq-dev && cargo install diesel_cli

      - name: Hasura setup
        run: |
          sudo apt-get install curl
          curl -L https://github.com/hasura/graphql-engine/raw/stable/cli/get.sh | bash

      - name: Redeployment script
        run: |
          echo "${{ secrets.SANDBOX_ENV }}" > sandbox.env
          scripts/redeploy.sh sandbox

      - name: Check inconsistencies
        run: |
          (cd hasura && hasura metadata ic list --envfile ../sandbox.env --output json > ../ic.json)

      - name: Print inconsistencies
        run: |
          echo "Finished meta apply, inconsitency json:"
          cat ic.json

      - name: Extract inconsistencies
        uses: sergeysova/jq-action@v2
        id: result
        with:
          cmd: "jq length ic.json"

      - name: Error if there are inconsistencies
        run: |
          [ "${{ steps.result.outputs.value }}" = ""  ] && exit 0 || exit 1
