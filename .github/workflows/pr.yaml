name: PR Mergecheck

on:
  pull_request:

jobs:
  ci:
    name: Merge Checks, Sandbox CI
    runs-on: ubuntu-22.04

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: minterop
        ports:
          - 5432:5432
        options:
          --health-cmd "pg_isready -d minterop -U postgres" --health-interval 3s
          --health-timeout 5s --health-retries 3

    container:
      image: ghcr.io/mintbase/diesel-builder:latest
      credentials:
        username: ${{ github.ACTOR }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Test Migrations Locally
        run: |
          DATABASE_URL=postgres://postgres:password@localhost:5432/minterop diesel migration run

      - name: "Apply hasura metadata to sandbox"
        run: |
          npm i -g hasura-cli --y
          hasura metadata apply --project hasura --admin-secret "${{ secrets.HASURA_SANDBOX_ADMIN }}" --endpoint https://interop-sandbox.hasura.app/
          hasura metadata ic list --project hasura --admin-secret "${{ secrets.HASURA_SANDBOX_ADMIN }}" --endpoint https://interop-sandbox.hasura.app/ --output json > ic.json

      - name: Print any inconsistencies
        run: |
          echo "Finished meta apply, inconsitency json:"
          cat ic.json

      - name: Extract inconsistencies
        uses: sergeysova/jq-action@v2
        id: result
        with:
          cmd: "jq length ic.json"

      - name: Error if there are inconsistencies
        run: |
          [ "${{ steps.result.outputs.value }}" = ""  ] && exit 0 || exit 1
